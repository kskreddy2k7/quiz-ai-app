#:import Theme app.ui.theme.Theme


<ChatBubble>:
    size_hint_y: None
    height: self.minimum_height
    size_hint_x: 1
    padding: [dp(20), dp(5)] 

    BoxLayout:
        size_hint_x: 0.85
        pos_hint: {"right": 1} if root.is_user else {"x": 0}
        size_hint_y: None
        height: self.minimum_height
        orientation: "vertical"
        
        canvas.before:
            Color:
                rgba: Theme.color(Theme.PRIMARY, 0.2) if root.is_user else Theme.color(Theme.BG_CARD, 0.8)
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [dp(18), dp(18), dp(4), dp(18)] if root.is_user else [dp(18), dp(18), dp(18), dp(4)]
            # Glow for AI
            Color:
                rgba: Theme.color(Theme.SECONDARY, 0.3) if not root.is_user else [0,0,0,0]
            Line:
                rounded_rectangle: [self.x, self.y, self.width, self.height, dp(18)]
                width: 1

        Label:
            text: root.text
            size_hint_y: None
            height: self.texture_size[1] + dp(24) # Padding vertical
            text_size: self.width - dp(24), None
            color: Theme.color(Theme.TEXT_PRIMARY)
            markup: True
            halign: "left"
            valign: "middle"
            padding: dp(12), dp(12)

<AIChatScreen>:
    canvas.before:
        Color:
            rgba: Theme.color(Theme.BG_DARK)
        Rectangle:
            pos: self.pos
            size: self.size
        
        # Tech Lines
        Color:
            rgba: Theme.color(Theme.PRIMARY, 0.05)
        Line:
            points: [self.width * 0.2, 0, self.width * 0.2, self.height]
            width: 1
        Line:
            points: [self.width * 0.8, 0, self.width * 0.8, self.height]
            width: 1


    BoxLayout:
        orientation: "vertical"
        padding: "0dp"
        spacing: "0dp"

        # --- Header ---
        BoxLayout:
            size_hint_y: None
            height: "64dp"
            spacing: "16dp"
            padding: "16dp"
            canvas.before:
                Color:
                    rgba: Theme.color(Theme.BG_CARD, 0.8)
                Rectangle:
                    pos: self.pos
                    size: self.size

            Button:
                text: "‚Üê BACK"
                font_size: "12sp"
                bold: True
                size_hint_x: None
                width: "80dp"
                background_normal: ""
                background_color: 0,0,0,0
                color: Theme.color(Theme.TEXT_SECONDARY)
                on_release: app.go_home()
                canvas.before:
                    Color:
                        rgba: Theme.color(Theme.BG_CARD)
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [8]

            Label:
                text: "AI DOUBT SOLVER"
                font_size: Theme.FONT_H2
                bold: True
                color: Theme.color(Theme.TEXT_PRIMARY)
                halign: "left"
                valign: "middle"
                text_size: self.size

        # --- Chat Area ---
        RecycleView:
            id: chat_list
            viewclass: "ChatBubble"
            scroll_type: ['bars', 'content']
            bar_width: "8dp"
            
            RecycleBoxLayout:
                default_size: None, None
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: 'vertical'
                spacing: "16dp"
                padding: "16dp"

        # --- Loading & Status ---
        Label:
            text: root.status_text
            size_hint_y: None
            height: "24dp" if root.status_text else "0dp"
            opacity: 1 if root.status_text else 0
            color: Theme.color(Theme.ACCENT_YELLOW)
            font_size: "12sp"

        # --- Input Area ---
        BoxLayout:
            size_hint_y: None
            height: "80dp"
            spacing: "12dp"
            padding: "16dp"
            canvas.before:
                Color:
                    rgba: Theme.color(Theme.BG_CARD, 0.9)
                Rectangle:
                    pos: self.pos
                    size: self.size

            AnimatedInput:
                id: msg_input
                hint_text: "Ask me anything..."
                multiline: False
                on_text_validate: 
                    root.send_message(self.text)
                    self.text = ""

            NeonButton:
                text: "SEND"
                size_hint_x: None
                width: "80dp"
                on_release: 
                    root.send_message(msg_input.text)
                    msg_input.text = ""
