#:import Theme app.ui.theme.Theme
#:include app/ui/components.kv

<ChatBubble>:
    size_hint_y: None
    height: self.minimum_height
    size_hint_x: 1
    padding: [dp(20), dp(5)] 

    BoxLayout:
        size_hint_x: 0.85
        pos_hint: {"right": 1} if root.is_user else {"x": 0}
        size_hint_y: None
        height: self.minimum_height
        orientation: "vertical"
        
        canvas.before:
            Color:
                rgba: root.bg_color
            RoundedRectangle:
                pos: self.pos
                size: self.size
                radius: [dp(18), dp(18), dp(4), dp(18)] if root.is_user else [dp(18), dp(18), dp(18), dp(4)]
            # Glow for AI
            Color:
                rgba: Theme.get_color(Theme.SECONDARY, 0.3) if not root.is_user else [0,0,0,0]
            Line:
                rounded_rectangle: [self.x, self.y, self.width, self.height, dp(18)]
                width: 1

        Label:
            text: root.text
            size_hint_y: None
            height: self.texture_size[1] + dp(24) # Padding vertical
            text_size: self.width - dp(24), None
            color: root.text_color
            markup: True
            halign: "left"
            valign: "middle"
            font_name: Theme.FONT_BODY
            padding: dp(12), dp(12)

<AIChatScreen>:
    canvas.before:
        Color:
            rgba: Theme.get_color(Theme.BG_DARK)
        Rectangle:
            pos: self.pos
            size: self.size
        
        # Tech Lines
        Color:
            rgba: Theme.get_color(Theme.PRIMARY_START, 0.05)
        Line:
            points: [self.width * 0.2, 0, self.width * 0.2, self.height]
            width: 1
        Line:
            points: [self.width * 0.8, 0, self.width * 0.8, self.height]
            width: 1


    BoxLayout:
        orientation: "vertical"
        padding: dp(0)
        spacing: dp(0)

        # --- Header ---
        BoxLayout:
            size_hint_y: None
            height: dp(64)
            spacing: dp(16)
            padding: dp(16)
            canvas.before:
                Color:
                    rgba: Theme.get_color(Theme.CARD_DARK, 0.8)
                Rectangle:
                    pos: self.pos
                    size: self.size

            Button:
                text: "‚Üê BACK"
                font_size: "12sp"
                bold: True
                size_hint_x: None
                width: dp(80)
                background_normal: ""
                background_color: 0,0,0,0
                color: Theme.get_color(Theme.TEXT_SECONDARY)
                on_release: app.go_home()
                canvas.before:
                    Color:
                        rgba: Theme.get_color(Theme.BG_LIGHT, 0.1) # visible on dark
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [dp(8)]

            Label:
                text: "AI DOUBT SOLVER"
                font_size: Theme.H2_SIZE
                font_name: Theme.FONT_HEADINGS
                bold: True
                color: Theme.get_color(Theme.TEXT_PRIMARY)
                halign: "left"
                valign: "middle"
                text_size: self.size

        # --- Chat Area ---
        RecycleView:
            id: chat_list
            viewclass: "ChatBubble"
            scroll_type: ['bars', 'content']
            bar_width: dp(8)
            
            RecycleBoxLayout:
                default_size: None, None
                default_size_hint: 1, None
                size_hint_y: None
                height: self.minimum_height
                orientation: 'vertical'
                spacing: dp(16)
                padding: dp(16)

        # --- Loading & Status ---
        Label:
            text: root.status_text
            size_hint_y: None
            height: dp(24) if root.status_text else dp(0)
            opacity: 1 if root.status_text else 0
            color: Theme.get_color(Theme.ACCENT_PURPLE)
            font_size: "12sp"

        # --- Input Area ---
        BoxLayout:
            size_hint_y: None
            height: dp(80)
            spacing: dp(12)
            padding: dp(16)
            canvas.before:
                Color:
                    rgba: Theme.get_color(Theme.CARD_DARK, 0.9)
                Rectangle:
                    pos: self.pos
                    size: self.size

            InputBox:
                id: msg_input
                hint_text: "Ask me anything..."
                multiline: False
                on_text_validate: root.send_message(self.text); self.text = ""

            PrimaryButton:
                text: "SEND"
                size_hint_x: None
                width: dp(80)
                on_release: 
                    root.send_message(msg_input.text)
                    msg_input.text = ""
