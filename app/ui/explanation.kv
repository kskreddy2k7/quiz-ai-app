#:import Theme app.ui.theme.Theme

<ExplanationScreen>:
    canvas.before:
        Color:
            rgba: Theme.color(Theme.BG_DARK)
        Rectangle:
            pos: self.pos
            size: self.size
        # Background Pattern
        Color:
            rgba: Theme.color(Theme.SECONDARY, 0.05)
        Ellipse:
            pos: self.width * 0.7, self.height * 0.7
            size: self.width * 0.5, self.width * 0.5

    BoxLayout:
        orientation: "vertical"
        padding: "20dp"
        spacing: "16dp"

        # --- Header ---
        BoxLayout:
            size_hint_y: None
            height: "48dp"
            spacing: "12dp"
            Button:
                text: "← Quit"
                size_hint: None, None
                size: "44dp", "44dp"
                background_normal: ""
                background_color: Theme.color(Theme.BG_CARD, 0.5)
                on_release: app.go_home()
                canvas.before:
                    Color:
                        rgba: self.background_color
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [12]
            Label:
                text: "Insight"
                font_size: Theme.FONT_H2
                bold: True
                color: Theme.color(Theme.TEXT_PRIMARY)
                halign: "left"
                valign: "middle"

        # --- Status Card ---
        Label:
            text: root.result_text
            font_size: "24sp"
            bold: True
            color: Theme.color(Theme.ACCENT_TEAL) if root.result_text.startswith("✅") else Theme.color(Theme.ACCENT_RED)
            size_hint_y: None
            height: "40dp"
            
        # --- Explanation Content ---
        BoxLayout:
            orientation: "vertical"
            padding: "16dp"
            spacing: "10dp"
            
            canvas.before:
                Color:
                    rgba: Theme.color(Theme.BG_CARD, 0.6)
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [20]
                Color:
                    rgba: Theme.color(Theme.PRIMARY, 0.3)
                Line:
                    rounded_rectangle: [self.x, self.y, self.width, self.height, 20]
                    width: 1

            Label:
                text: root.explanation_text
                font_size: "16sp"
                color: Theme.color(Theme.TEXT_PRIMARY)
                text_size: self.width, None
                halign: "center"
                size_hint_y: None
                height: self.texture_size[1]
            
            ScrollView:
                do_scroll_x: False
                BoxLayout:
                    orientation: "vertical"
                    spacing: "12dp"
                    size_hint_y: None
                    height: self.minimum_height
                    padding: [0, "10dp", 0, "10dp"]
                    
                    # Detailed breakdown
                    Label:
                        text: "Why it's " + ("correct" if root.result_text.startswith("✅") else "incorrect") + ":"
                        color: Theme.color(Theme.SECONDARY)
                        font_size: "12sp"
                        size_hint_y: None
                        height: "20dp"
                        halign: "left"
                        text_size: self.width, None

                    Label:
                        text: root.correct_explanation
                        color: Theme.color(Theme.TEXT_SECONDARY)
                        text_size: self.width, None
                        size_hint_y: None
                        height: self.texture_size[1]
                        
                    Label:
                        text: "Did you know?" if root.wrong_explanations_text else ""
                        color: Theme.color(Theme.SECONDARY)
                        font_size: "12sp"
                        size_hint_y: None
                        height: "20dp" if root.wrong_explanations_text else "0dp"
                        halign: "left"
                        text_size: self.width, None
                        
                    Label:
                        text: root.wrong_explanations_text
                        color: Theme.color(Theme.TEXT_SECONDARY)
                        text_size: self.width, None
                        font_size: "13sp"
                        size_hint_y: None
                        height: self.texture_size[1]

        # --- Next Button ---
        Button:
            text: root.next_label
            size_hint_y: None
            height: "56dp"
            background_normal: ""
            background_color: [0, 0, 0, 0]
            on_release: app.next_question() if root.next_label == "Next" else app.show_results()
            
            canvas.before:
                Color:
                    rgba: Theme.color(Theme.PRIMARY)
                RoundedRectangle:
                    pos: self.pos
                    size: self.size
                    radius: [28]
                # Glow
                Color:
                    rgba: Theme.color(Theme.PRIMARY, 0.4)
                RoundedRectangle:
                    pos: [self.x - 2, self.y - 4]
                    size: [self.width + 4, self.height + 8]
                    radius: [32]
