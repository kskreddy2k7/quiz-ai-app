#:import Theme app.ui.theme.Theme
#:include app/ui/components.kv

<StyledSpinner@Spinner>:
    background_normal: ""
    background_down: ""
    background_color: 0,0,0,0
    color: Theme.get_color(Theme.TEXT_PRIMARY)
    font_name: Theme.FONT_BODY
    option_cls: "SpinnerOptionWidget"
    canvas.before:
        Color:
            rgba: Theme.get_color(Theme.BG_CARD)
        RoundedRectangle:
            pos: self.pos
            size: self.size
            radius: [dp(12)]
        Color:
            rgba: Theme.get_color(Theme.PRIMARY_START, 0.5)
        Line:
            rounded_rectangle: [self.x, self.y, self.width, self.height, dp(12)]
            width: dp(1)
    # Add an arrow icon? simplified for now

<SpinnerOptionWidget@SpinnerOption>:
    background_normal: ""
    background_color: Theme.get_color(Theme.CARD_DARK)
    color: Theme.get_color(Theme.TEXT_PRIMARY)
    font_name: Theme.FONT_BODY
    height: dp(40)

<QuizSetupScreen>:
    canvas.before:
        Color:
            rgba: Theme.get_color(Theme.BG_DARK)
        Rectangle:
            pos: self.pos
            size: self.size
        # Diagonal Glow
        Color:
            rgba: Theme.get_color(Theme.SECONDARY, 0.05)
        Triangle:
            points: [0, 0, self.width, 0, 0, self.height]

    BoxLayout:
        orientation: "vertical"
        padding: dp(20)
        spacing: dp(16)

        # --- Header ---
        BoxLayout:
            size_hint_y: None
            height: dp(48)
            spacing: dp(12)
            Button:
                text: "‚Üê"
                font_name: Theme.FONT_HEADINGS
                font_size: "24sp"
                size_hint: None, None
                size: dp(44), dp(44)
                background_normal: ""
                background_color: 0,0,0,0
                on_release: app.go_home()
                canvas.before:
                    Color:
                        rgba: Theme.get_color(Theme.CARD_DARK)
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [dp(12)]
            Label:
                text: "Setup Quiz"
                font_size: Theme.H2_SIZE
                font_name: Theme.FONT_HEADINGS
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size
                color: Theme.get_color(Theme.TEXT_PRIMARY)

        ScrollView:
            do_scroll_x: False
            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                spacing: dp(20)

                # --- TOPIC MODE ---
                KVCard:
                    id: topic_card
                    size_hint_y: None
                    height: root.topic_height
                    opacity: root.topic_opacity
                    disabled: root.topic_disabled
                    padding: root.topic_padding
                    
                    Label:
                        text: "TOPIC SELECTION"
                        font_size: "12sp"
                        bold: True
                        font_name: Theme.FONT_BUTTON
                        color: Theme.get_color(Theme.ACCENT_CYAN)
                        size_hint_y: None
                        height: dp(20)
                        halign: "left"
                        text_size: self.size

                    GridLayout:
                        cols: 1
                        spacing: dp(16)
                        size_hint_y: None
                        height: self.minimum_height

                        BoxLayout:
                            orientation: "vertical"
                            spacing: dp(8)
                            size_hint_y: None
                            height: dp(60)
                            KVLabel:
                                text: "Subject"
                                size_hint_y: None
                                height: dp(20)
                            StyledSpinner:
                                text: root.selected_subject or "Choose Subject..."
                                values: root.subjects
                                on_text: root.set_subject(self.text, app._data_path("subjects.json"))

                        BoxLayout:
                            orientation: "vertical"
                            spacing: dp(8)
                            size_hint_y: None
                            height: dp(60)
                            KVLabel:
                                text: "Topic (Optional)"
                                size_hint_y: None
                                height: dp(20)
                            StyledSpinner:
                                text: root.selected_topic or "Any Topic"
                                values: root.topics
                                on_text: root.set_topic(self.text)

                # --- CONFIGURATION ---
                KVCard:
                    size_hint_y: None
                    height: self.minimum_height
                    padding: dp(20)
                    spacing: dp(16) # Override KVCard spacing

                    Label:
                        text: "CONFIGURATION"
                        font_size: "12sp"
                        bold: True
                        font_name: Theme.FONT_BUTTON
                        color: Theme.get_color(Theme.ACCENT_CYAN)
                        size_hint_y: None
                        height: dp(20)
                        halign: "left"
                        text_size: self.size

                    # Num Questions
                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(60)
                        spacing: dp(8)
                        BoxLayout:
                            size_hint_y: None
                            height: dp(20)
                            KVLabel:
                                text: "Questions"
                            Label:
                                text: str(int(num_q_slider.value))
                                font_size: "14sp"
                                bold: True
                                halign: "right"
                                color: Theme.get_color(Theme.PRIMARY_START)
                                text_size: self.size
                        
                        Slider:
                            id: num_q_slider
                            min: 5
                            max: 20
                            step: 1
                            value: 5
                            on_value: root.num_questions = int(self.value)
                            cursor_size: dp(20), dp(20)
                            value_track: True
                            value_track_color: Theme.get_color(Theme.PRIMARY_START)

                    # Difficulty
                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: dp(60)
                        spacing: dp(8)
                        KVLabel:
                            text: "Difficulty"
                            size_hint_y: None
                            height: dp(20)
                        StyledSpinner:
                            text: root.selected_difficulty
                            values: root.difficulties
                            on_text: root.set_difficulty(self.text)

                # --- FILE MODE ---
                KVCard:
                    id: file_card
                    size_hint_y: None
                    height: root.file_height
                    opacity: root.file_opacity
                    disabled: root.file_disabled
                    padding: root.file_padding
                    spacing: dp(16)
                    
                    Label:
                        text: "SOURCE MATERIAL"
                        font_size: "12sp"
                        bold: True
                        font_name: Theme.FONT_BUTTON
                        color: Theme.get_color(Theme.SECONDARY)
                        size_hint_y: None
                        height: dp(20)
                        halign: "left"
                        text_size: self.size

                    BoxLayout:
                        size_hint_y: None
                        height: dp(48)
                        spacing: dp(12)
                        
                        AccentButton:
                            text: "Upload File üìÇ"
                            font_size: "14sp"
                            size_hint_x: 0.5
                            on_release: root.open_file_chooser()
                        
                        Label:
                            text: root.upload_status
                            font_size: "12sp"
                            text_size: self.size
                            halign: "left"
                            valign: "middle"
                            color: Theme.get_color(Theme.TEXT_SUCCESS) if "Success" in root.upload_status else Theme.get_color(Theme.TEXT_SECONDARY)

                    Label:
                        text: "OR Paste Text:"
                        font_size: "14sp"
                        color: Theme.get_color(Theme.TEXT_SECONDARY)
                        size_hint_y: None
                        height: dp(20)
                        halign: "left"
                        text_size: self.size

                    InputBox:
                        hint_text: "Paste notes here..."
                        multiline: True
                        on_text: root.custom_text = self.text

                    BoxLayout:
                        size_hint_y: None
                        height: dp(40)
                        orientation: "vertical"
                        Label:
                            text: f"Total Context: {len(root.custom_text) + len(root.file_text_cache)} chars"
                            color: Theme.get_color(Theme.TEXT_SECONDARY)
                            font_size: "12sp"
                            halign: "left"
                            text_size: self.size
                        Label:
                            text: "Preview: " + (root.file_text_cache[:40] + "...") if root.file_text_cache else ""
                            color: Theme.get_color(Theme.ACCENT_CYAN)
                            font_size: "10sp"
                            halign: "left"
                            text_size: self.size

        Label:
            text: root.status_text
            font_size: "12sp"
            color: Theme.get_color(Theme.ACCENT_PURPLE) # Warning color used for status
            size_hint_y: None
            height: dp(20) if self.text else dp(0)

        PrimaryButton:
            text: "Generate Quiz ‚ú®" if root.mode == 'file' else "Start Quiz üöÄ"
            size_hint_y: None
            height: dp(56)
            disabled: (root.mode == 'file' and (len(root.custom_text) + len(root.file_text_cache)) < 50) or (root.mode == 'topic' and not root.selected_subject)
            opacity: 0.5 if self.disabled else 1
            on_release: root.create_quiz()
