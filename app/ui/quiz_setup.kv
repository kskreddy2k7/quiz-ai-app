#:import Theme app.ui.theme.Theme
#:import os os


<StyledSpinner@Spinner>:
    background_normal: ""
    background_down: ""
    background_color: Theme.color(Theme.BG_OVERLAY, 0.5)
    color: Theme.color(Theme.TEXT_PRIMARY)
    option_cls: "SpinnerOption"
    canvas.before:
        Color:
            rgba: Theme.color(Theme.PRIMARY, 0.5)
        Line:
            rounded_rectangle: [self.x, self.y, self.width, self.height, dp(12)]
            width: 1

<SpinnerOption>:
    background_normal: ""
    background_color: Theme.color(Theme.BG_CARD)
    color: Theme.color(Theme.TEXT_PRIMARY)
    height: "40dp"

<QuizSetupScreen>:
    canvas.before:
        Color:
            rgba: Theme.color(Theme.BG_DARK)
        Rectangle:
            pos: self.pos
            size: self.size
        # Diagonal Glow
        Color:
            rgba: Theme.color(Theme.SECONDARY, 0.05)
        Triangle:
            points: [0, 0, self.width, 0, 0, self.height]

    BoxLayout:
        orientation: "vertical"
        padding: "20dp"
        spacing: "16dp"

        # --- Header ---
        BoxLayout:
            size_hint_y: None
            height: "48dp"
            spacing: "12dp"
            Button:
                text: "‚Üê"
                size_hint: None, None
                size: "44dp", "44dp"
                background_normal: ""
                background_color: 0,0,0,0
                on_release: app.go_home()
                canvas.before:
                    Color:
                        rgba: Theme.color(Theme.BG_CARD, 0.5)
                    RoundedRectangle:
                        pos: self.pos
                        size: self.size
                        radius: [12]
            Label:
                text: "Create Quiz (File)" if root.mode == 'file' else "Create Quiz (Topic)"
                font_size: Theme.FONT_H2
                bold: True
                halign: "left"
                valign: "middle"
                text_size: self.size

        ScrollView:
            do_scroll_x: False
            BoxLayout:
                orientation: "vertical"
                size_hint_y: None
                height: self.minimum_height
                spacing: "20dp"

                # --- TOPIC MODE: Subject Selection ---
                GlassCard:
                    id: topic_card
                    size_hint_y: None
                    height: root.topic_height
                    opacity: root.topic_opacity
                    disabled: root.topic_disabled
                    padding: root.topic_padding
                    
                    Label:
                        text: "TOPIC SELECTION"
                        font_size: "12sp"
                        bold: True
                        color: Theme.color(Theme.ACCENT_TEAL)
                        size_hint_y: None
                        height: "20dp"
                        halign: "left"
                        text_size: self.size

                    GridLayout:
                        cols: 1
                        spacing: "16dp"
                        size_hint_y: None
                        height: self.minimum_height

                        # Subject
                        BoxLayout:
                            orientation: "vertical"
                            spacing: "8dp"
                            size_hint_y: None
                            height: "60dp"
                            Label:
                                text: "Subject"
                                size_hint_y: None
                                height: "20dp"
                                font_size: "14sp"
                                halign: "left"
                                text_size: self.size
                            StyledSpinner:
                                text: root.selected_subject or "Choose Subject..."
                                values: root.subjects
                                on_text: root.set_subject(self.text, app._data_path("subjects.json"))

                        # Topic
                        BoxLayout:
                            orientation: "vertical"
                            spacing: "8dp"
                            size_hint_y: None
                            height: "60dp"
                            Label:
                                text: "Topic (Optional)"
                                size_hint_y: None
                                height: "20dp"
                                font_size: "14sp"
                                halign: "left"
                                text_size: self.size
                            StyledSpinner:
                                text: root.selected_topic or "Any Topic"
                                values: root.topics
                                on_text: root.set_topic(self.text)


                # --- Configuration ---
                GlassCard:
                    size_hint_y: None
                    height: self.minimum_height
                    padding: "20dp"
                    spacing: "16dp"

                    Label:
                        text: "CONFIGURATION"
                        font_size: "12sp"
                        bold: True
                        color: Theme.color(Theme.ACCENT_TEAL)
                        size_hint_y: None
                        height: "20dp"
                        halign: "left"
                        text_size: self.size

                    # Num Questions
                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: "60dp"
                        spacing: "8dp"
                        BoxLayout:
                            size_hint_y: None
                            height: "20dp"
                            Label:
                                text: "Questions"
                                font_size: "14sp"
                                halign: "left"
                                text_size: self.size
                            Label:
                                text: str(int(num_q_slider.value))
                                font_size: "14sp"
                                bold: True
                                halign: "right"
                                color: Theme.color(Theme.PRIMARY)
                                text_size: self.size
                        
                        Slider:
                            id: num_q_slider
                            min: 5
                            max: 20
                            step: 1
                            value: 5
                            on_value: root.num_questions = int(self.value)
                            cursor_size: "20dp", "20dp"
                            value_track: True
                            value_track_color: Theme.color(Theme.PRIMARY)

                    # Question Type
                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: "60dp"
                        spacing: "8dp"
                        Label:
                            text: "Type"
                            font_size: "14sp"
                            halign: "left"
                            text_size: self.size
                            size_hint_y: None
                            height: "20dp"
                        StyledSpinner:
                            text: root.question_type or "Mixed"
                            values: ["Multiple Choice", "True/False", "Mixed"]
                            on_text: root.question_type = self.text

                    # Difficulty (Moved to common config)
                    BoxLayout:
                        orientation: "vertical"
                        size_hint_y: None
                        height: "60dp"
                        spacing: "8dp"
                        Label:
                            text: "Difficulty"
                            font_size: "14sp"
                            halign: "left"
                            text_size: self.size
                            size_hint_y: None
                            height: "20dp"
                        StyledSpinner:
                            text: root.selected_difficulty
                            values: root.difficulties
                            on_text: root.set_difficulty(self.text)

                # --- FILE MODE: Context & Upload ---
                GlassCard:
                    id: file_card
                    size_hint_y: None
                    height: root.file_height
                    opacity: root.file_opacity
                    disabled: root.file_disabled
                    padding: root.file_padding
                    spacing: "16dp"
                    
                    Label:
                        text: "SOURCE MATERIAL"
                        font_size: "12sp"
                        bold: True
                        color: Theme.color(Theme.SECONDARY)
                        size_hint_y: None
                        height: "20dp"
                        halign: "left"
                        text_size: self.size

                    # File Upload
                    BoxLayout:
                        size_hint_y: None
                        height: "48dp"
                        spacing: "12dp"
                        
                        NeonButton:
                            text: "Upload File üìÇ"
                            font_size: "14sp"
                            size_hint_x: 0.4
                            on_release: root.open_file_chooser()
                        
                        Label:
                            text: root.upload_status
                            font_size: "12sp"
                            text_size: self.size
                            halign: "left"
                            valign: "middle"
                            color: Theme.color(Theme.ACCENT_TEAL) if "Success" in root.upload_status else Theme.color(Theme.SECONDARY)

                    Label:
                        text: "OR Paste Text:"
                        font_size: "14sp"
                        color: Theme.color(Theme.TEXT_SECONDARY)
                        size_hint_y: None
                        height: "20dp"
                        halign: "left"
                        text_size: self.size

                    AnimatedInput:
                        hint_text: "Paste notes here..."
                        multiline: True
                        on_text: root.custom_text = self.text

                    # Text Validation / Preview
                    BoxLayout:
                        size_hint_y: None
                        height: "40dp"
                        orientation: "vertical"
                        Label:
                            text: f"Total Context: {len(root.custom_text) + len(root.file_text_cache)} chars"
                            color: Theme.color(Theme.TEXT_SECONDARY)
                            font_size: "12sp"
                            halign: "left"
                            text_size: self.size
                        Label:
                            text: "Preview Extraction: " + (root.file_text_cache[:50] + "...") if root.file_text_cache else ""
                            color: Theme.color(Theme.ACCENT_TEAL)
                            font_size: "10sp"
                            halign: "left"
                            text_size: self.size

        # --- Status ---
        Label:
            text: root.status_text
            font_size: "12sp"
            color: Theme.color(Theme.ACCENT_YELLOW)
            size_hint_y: None
            height: "20dp" if self.text else "0dp"

        # --- Action Button ---
        NeonButton:
            text: "Generate Quiz ‚ú®" if root.mode == 'file' else "Start Quiz üöÄ"
            size_hint_y: None
            height: "56dp"
            disabled: (root.mode == 'file' and (len(root.custom_text) + len(root.file_text_cache)) < 50) or (root.mode == 'topic' and not root.selected_subject)
            opacity: 0.5 if self.disabled else 1
            on_release: root.create_quiz()
